##
## RetroArch-related features.
##
## dragonshark-games-enumerate-external-device-dirs
## dragonshark-games-set-roms-dir
## dragonshark-games-get-roms-dir
## dragonshark-games-saves-backup
## dragonshark-games-saves-restore

# Enumerates the media directories belonging to mounted devices.
# The enumerated directories belong to /media/$USER.
function dragonshark-games-enumerate-external-device-dirs() {
    lsblk -o MOUNTPOINT | grep "/media/$USER"
}

# Gets the root directory of the media device's directory.
function __dragonshark-games-get-root() {
    echo "$1" | grep -Po "^/media/[^/]+/[^/]+"
}

# Sets the new ROMs directory. The directory must exist and also
# belong to /media/$USER.
function dragonshark-games-set-roms-dir() {
    if [[ ! -d "$1" ]]
    then
        echo "The given roms dir does not exist" 1>&2
        return 2
    fi

    DEV_DIR=$(__dragonshark-games-get-root "$1")
    if [[ ! $? ]]
    then
        echo "The given roms dir is not an external media directory" 1>&2
        return 1
    fi

    dragonshark-games-enumerate-external-device-dirs | grep "$DEV_DIR" > /dev/null
    if [[ ! $? ]]
    then
        echo "The given roms dir is not an external media directory" 1>&2
        return 1
    fi

    sed "s|%ROMS%|$1|g" $HOME/.emulationstation/es_systems.template.cfg > $HOME/.emulationstation/es_systems.cfg
}

# Gets the new ROMs directory.
function dragonshark-games-get-roms-dir() {
    DIR=$(cat ~/.emulationstation/es_systems.cfg | grep -Po "<path>\K.*(?=</path>)" | head -n 1)
    if [[ ! $? ]]
    then
        echo "Could not retrieve the current ROMs directory" 1>&2
        return 1
    fi

    echo $(dirname $DIR)
}

# Makes a backup of the save states.
function dragonshark-games-saves-backup() {
    rm "$1/backup.zip"
    cd /mnt/SAVES && zip -r "$1/backup.zip" ./*
    return $?
}

# Applies a backup of the save states.
function dragonshark-games-saves-restore() {
    unzip -o "$1/backup.zip" -d /mnt/SAVES
}
